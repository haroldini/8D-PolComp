
<!DOCTYPE html>
<link rel="stylesheet" href="{{ url_for('static', filename='css/data.css')}}">

<script>
    // Declare order for demographics box cycling
    let first_box = "identities-container";
    let current_box = first_box;

    const input_box_order = {
        "identities-container": "demographics-container",
        "demographics-container": "end"
    };

    // ===== hCaptcha implementation =====

    function showStatus(msg) {
        document.getElementById("recaptcha-status").innerText = msg;
    }

    function getCaptchaToken() {
        if (window.hcaptcha && typeof window.hcaptcha.getResponse === "function") {
            return window.hcaptcha.getResponse();
        }
        return null;
    }

    function resetCaptcha() {
        if (window.hcaptcha && typeof window.hcaptcha.reset === "function") {
            window.hcaptcha.reset();
        }
    }

    function setSubmitEnabled(enabled) {
        const btn = document.getElementById("continue-btn");
        if (!btn) {
            return;
        }
        btn.disabled = !enabled;
        if (btn.disabled) {
            btn.classList.add("disabled");
        } else {
            btn.classList.remove("disabled");
        }
    }

    function waitForHCaptchaApi(maxMs) {
        const start = Date.now();

        return new Promise(function(resolve) {
            (function tick() {
                if (window.hcaptcha) {
                    resolve(true);
                    return;
                }
                if (Date.now() - start > maxMs) {
                    resolve(false);
                    return;
                }
                setTimeout(tick, 50);
            })();
        });
    }

    function startFinalStepCaptchaGate() {
        showStatus("Complete the captcha to continue.");
        setSubmitEnabled(false);

        waitForHCaptchaApi(5000).then(function(ok) {
            if (!ok) {
                showStatus("Captcha failed to load. Disable blockers or refresh and try again.");
                setSubmitEnabled(false);
                return;
            }
            const token = getCaptchaToken();
            if (token) {
                setSubmitEnabled(true);
            }
        });
    }

    // hCaptcha callbacks
    function onCaptchaSuccess(token) {
        showStatus("");
        setSubmitEnabled(true);
    }

    function onCaptchaExpired() {
        showStatus("Captcha expired. Please complete it again.");
        setSubmitEnabled(false);
    }

    function onCaptchaError() {
        showStatus("Captcha error (network/blocked). Refresh and try again.");
        setSubmitEnabled(false);
    }

    // Triggers when save & continue button pressed
    function goto_results() {

        // Cycle through boxes
        let next_box = input_box_order[current_box];
        if (next_box !== "end") {
            document.getElementById(current_box).style.display = "none";
            document.getElementById(next_box).style.display = "block";

            // Update the button text on final section
            current_box = next_box;
            next_box = input_box_order[current_box];

            if (next_box === "end") {
                document.getElementById("next-btn-text").innerText = "Save & Continue";
                document.getElementById("captcha").style.display = "flex";
                startFinalStepCaptchaGate();
            }

            return;
        }

        // Final submit step - check token
        const token = getCaptchaToken();
        if (token === null) {
            showStatus("Captcha failed to load. Disable blockers or refresh and try again.");
            setSubmitEnabled(false);
            return;
        }
        if (!token) {
            showStatus("Please complete the captcha before continuing.");
            setSubmitEnabled(false);
            return;
        }
        showStatus("");
        setSubmitEnabled(false);

        // Submit results
        $(function () {

            const ageVal = $('select[name=age]').val();
            let form_age = -1;
            if (ageVal !== null && ageVal !== "" && ageVal !== "-1") {
                form_age = Number(ageVal);
            }

            let demographics = {
                "age": form_age,
                "country": $('select[name=country]').val() || "",
                "religion": $('select[name=religion]').val() || "",
                "ethnicity": $('select[name=ethnicity]').val() || "",
                "education": $('select[name=education]').val() || "",
                "party": $('select[name=party]').val() || "",
                "identities": $('select[name=identities]').val() || [],
            };

            $.ajax({
                type: "POST",
                url: "/api/to_results",
                contentType:'application/json',
                data: JSON.stringify({
                    "captcha": token,
                    "demographics": demographics
                }),
                success: function (req) {
                    let results_id = req.results_id;
                    window.location = "/results/" + results_id;
                },
                error: function (xhr) {
                    const msg =
                        (xhr.responseJSON && xhr.responseJSON.status) ||
                        ("Request failed (" + xhr.status + "). Please try again.");

                    showStatus(msg);
                    resetCaptcha();
                    startFinalStepCaptchaGate();
                }
            });
        });
    }
</script>

{% extends "layouts/base.html" %}

{% block TITLE %} â€¢ Test{% endblock %}
{% block CONTENT %}
<div class="component-border">
    <p class="text text-subtitle">Optional Questions</p>
    <div class="components-50-50">
        <div class="component-border component">
            <div style="width: 100%;">
                {% include "components/selects.html" %}
            </div>
        </div>
        <div class="component">
            <div class="component-border" style="height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                <p class="text">To improve 8D-PolComp's data, please answer as many of these questions as you can. They are completely optional, and will not influence your results.</p>
                <p class="text" style="font-weight: 600">Your responses to the test will be stored in 8D-PolComp's public database, alongside any of these optional questions you choose to answer.</p>
            </div>
            <div class="component-border">

                <!-- hCaptcha -->
                <div
                    id="captcha"
                    class="h-captcha"
                    data-sitekey="{{ site_key }}"
                    data-callback="onCaptchaSuccess"
                    data-expired-callback="onCaptchaExpired"
                    data-error-callback="onCaptchaError"
                    style="display: none; justify-content: center; align-items: center; transform: scale(0.77);"
                ></div>
                <p id='recaptcha-status' class="text" style="font-weight: 600; color: salmon; align-self: bottom;"></p>

                <button id="continue-btn" class="button blue-button" onclick="goto_results()">
                    <i class="fa-solid fa-right-long"></i>
                    <span id="next-btn-text">Next</span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
