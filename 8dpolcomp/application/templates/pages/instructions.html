
{% extends "layouts/base.html" %}

{% block TITLE %} â€¢ Test{% endblock %}

{% block CONTENT %}

<meta id="group-data" data-group="{{ group_id or '' }}">

<div class="component-border">
    <p class="text text-subtitle">Before you start</p>

    <!-- Main instructions -->
    <div class="components-50-50">
        <div class="component-border">
            <p class="text">
                You'll see a series of political statements. For each one, choose how much you agree or disagree.
                At the end, we'll calculate your results across 8 ideological axes.
            </p>
        </div>
    </div>

    <!-- Actions (group + continue) -->
    <div class="components-50-50">
        <div class="component-border">

            <!-- NOT IN GROUP -->
            <div id="group-inactive" style="display:none;">
                <p class="text" style="margin-bottom: 0.75rem;">
                    <b>Optional:</b> take the test as part of a group to compare results with friends.
                </p>
                <button
                    class="button grey-button center-content"
                    onclick="create_group()"
                >
                    <i class="fa-solid fa-people-group"></i><span>Start as a group</span>
                </button>
            </div>

            <!-- IN GROUP -->
            <div id="group-active" style="display:none;">
                <p class="text green" style="margin-bottom:0.25rem;">
                    <b>Group mode enabled.</b>
                </p>
                <p class="text" style="margin-bottom: 0.75rem; opacity: 0.9;">
                    Anyone who completes the test using your invite link will be added to your group.
                    You'll be able to compare your group's results later in the Data Explorer.
                </p>

                <button
                    class="button blue-button center-content"
                    onclick="copy_group_invite_link(event.currentTarget, btn_text='Copy Invite Link')"
                >
                    <i class="fa-solid fa-clipboard"></i><span>Copy Invite Link</span>
                </button>
                <button
                    class="button grey-button center-content"
                    onclick="leave_group()"
                >
                    <i class="fa-solid fa-xmark"></i><span>Leave Group</span>
                </button>
            </div>

        </div>
    </div>
    <div class="components-50-50">
        <div class="component-border">
            <!-- Continue button (bottom) -->
            <button class="button blue-button" onclick="start_test()">
                <span>Start Test</span><i class="fa-solid fa-right-long"></i>
            </button>

            <p id="instructions-error" class="text" style="display:none; margin-top:0.5rem; color: salmon; font-weight:600;"></p>
        </div>
    </div>
</div>

{% endblock %}

{% block SCRIPTS %}
<script>
    function _isUUID(s) {
        const v = String(s || "").trim();
        return /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/.test(v);
    }

    function _getGroupId() {
        const meta = document.getElementById("group-data");
        const gid = meta ? (meta.getAttribute("data-group") || "").trim() : "";
        return gid || "";
    }

    function _uuidFallback() {
        const hex = [...Array(256).keys()].map(i => (i).toString(16).padStart(2, "0"));
        const r = crypto.getRandomValues(new Uint8Array(16));
        r[6] = (r[6] & 0x0f) | 0x40;
        r[8] = (r[8] & 0x3f) | 0x80;
        return (
            hex[r[0]] + hex[r[1]] + hex[r[2]] + hex[r[3]] + "-" +
            hex[r[4]] + hex[r[5]] + "-" +
            hex[r[6]] + hex[r[7]] + "-" +
            hex[r[8]] + hex[r[9]] + "-" +
            hex[r[10]] + hex[r[11]] + hex[r[12]] + hex[r[13]] + hex[r[14]] + hex[r[15]]
        );
    }

    function set_instructions_error(msg) {
        const el = document.getElementById("instructions-error");
        if (!el) return;

        if (!msg) {
            el.style.display = "none";
            el.innerText = "";
            return;
        }

        el.style.display = "block";
        el.innerText = msg;
    }

    function create_group() {
        let gid = "";
        try {
            gid = (crypto && typeof crypto.randomUUID === "function") ? crypto.randomUUID() : _uuidFallback();
        } catch (e) {
            return;
        }

        // Reload this page in group mode
        window.location = "/instructions?g=" + encodeURIComponent(gid);
    }

    async function copy_group_invite_link(tar, btn_text = "Copy Invite Link") {
        const gid = _getGroupId();
        if (!gid || !_isUUID(gid) || !tar) return;

        disable_button(tar, "Copied");

        const link = window.location.origin + "/instructions?g=" + encodeURIComponent(gid);

        try {
            await navigator.clipboard.writeText(link);
        } catch (e) {
            const tmp = document.createElement("textarea");
            tmp.value = link;
            document.body.appendChild(tmp);
            tmp.select();
            document.execCommand("copy");
            document.body.removeChild(tmp);
        }

        setTimeout(function () {
            enable_button(tar, btn_text);
        }, 2500);
    }

    function leave_group() {
        window.location = "/instructions?g=clear";
    }

    function render_group_state() {
        const gid = _getGroupId();
        const inGroup = (gid && _isUUID(gid));

        const inactive = document.getElementById("group-inactive");
        const active = document.getElementById("group-active");
        const label = document.getElementById("group-id-label");

        if (label) label.innerText = inGroup ? gid : "";

        if (inactive) inactive.style.display = inGroup ? "none" : "block";
        if (active) active.style.display = inGroup ? "block" : "none";
    }

    render_group_state();

    function start_test() {
        set_instructions_error("");

        $.ajax({
            type: "POST",
            url: "/api/to_test",
            contentType: "application/json",
            data: JSON.stringify({ "action": "to_test" }),
            success: function () {
                window.location = "/test";
            },
            error: function (xhr) {
                const msg =
                    (xhr.responseJSON && xhr.responseJSON.status) ||
                    ("Request failed (" + xhr.status + "). Please refresh and try again.");

                set_instructions_error(msg);
            }
        });
    }
</script>
{% endblock %}
