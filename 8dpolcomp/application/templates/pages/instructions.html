
{% extends "layouts/base.html" %}

{% block TITLE %} â€¢ Test{% endblock %}

{% block CONTENT %}

<meta id="group-data" data-group="{{ group_id or '' }}">

<div class="component-border">
    <p class="text text-subtitle">Instructions</p>

    <div class="components-50-50">
        <div class="component-border">
            <p class="text">
                You will be shown a series of political statements, and your responses to them will be recorded.
                At the end of the test, your responses will be used to determine your position across eight ideological axes.
            </p>
        </div>
    </div>

    <div class="components-50-50" id="group-ui" style="display:none; margin-top: 12px;">
        <div class="component-border">
            <p class="text text-subtitle fade-border header-underline">Group Test (optional)</p>

            <div>

                <div id="group-setup" style="display:none;">
                    <p class="text" style="margin-bottom: 10px;">
                        Create a group and share the link. Anyone using the link will be added to the same group so you can compare results later.
                    </p>

                    <div class="components-50-50">
                        <div class="component-border">
                            <button class="button grey-button center-content flex" onclick="create_group()">
                                <i class="fa-solid fa-people-group"></i><span>Create Group</span>
                            </button>
                        </div>

                        <div class="component-border">
                            <input
                                id="group-id-input"
                                class="button grey-button"
                                style="width:100%; text-align:center;"
                                type="text"
                                placeholder="Paste Group ID (UUID)"
                                oninput="clear_group_error()"
                            >
                            <button class="button grey-button center-content flex" style="margin-top:8px;" onclick="join_group()">
                                <i class="fa-solid fa-right-to-bracket"></i><span>Join Group</span>
                            </button>

                            <p id="group-join-error" class="text" style="display:none; margin-top:8px; color: salmon; font-weight: 600;"></p>
                        </div>
                    </div>
                </div>

                <!-- In group -->
                <div id="group-active" class="component-border component" style="display:none;">
                    <p class="text green" style="margin-bottom:6px;">
                        <b>Current group:</b> <span id="group-id-label"></span>
                    </p>
                    <div class="wrapper">
                        <div class="wrapped">
                            <button class="button blue-button center-content flex" onclick="copy_group_link(event.currentTarget, btn_text='Copy Group Link')">
                                <i class="fa-solid fa-clipboard"></i><span>Copy Group Link</span>
                            </button>
                        </div>
                        <div class="wrapped">
                            <button class="button grey-button center-content flex" onclick="leave_group()">
                                <i class="fa-solid fa-xmark"></i><span>Leave Group</span>
                            </button>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <div class="components-50-50">
        <div class="component-border">
            <button class="button blue-button" onclick="start_test()">
                <i class="fa-solid fa-right-long"></i>Continue
            </button>
            <button
                id="toggle-group-ui"
                class="button grey-button center-content"
                onclick="toggle_group_ui(event.currentTarget)"
            >
                <i class="fa-solid fa-people-group"></i><span>Take the test as part of a group</span>
            </button>
            <p id="instructions-error" class="text" style="display:none; margin-top:8px; color: salmon; font-weight:600;"></p>
        </div>
    </div>

</div>

{% endblock %}

{% block SCRIPTS %}
<script>
    function _isUUID(s) {
        const v = String(s || "").trim();
        return /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/.test(v);
    }

    function _getGroupId() {
        const meta = document.getElementById("group-data");
        const gid = meta ? (meta.getAttribute("data-group") || "").trim() : "";
        return gid || "";
    }

    function _uuidFallback() {
        const hex = [...Array(256).keys()].map(i => (i).toString(16).padStart(2, "0"));
        const r = crypto.getRandomValues(new Uint8Array(16));
        r[6] = (r[6] & 0x0f) | 0x40;
        r[8] = (r[8] & 0x3f) | 0x80;
        return (
            hex[r[0]] + hex[r[1]] + hex[r[2]] + hex[r[3]] + "-" +
            hex[r[4]] + hex[r[5]] + "-" +
            hex[r[6]] + hex[r[7]] + "-" +
            hex[r[8]] + hex[r[9]] + "-" +
            hex[r[10]] + hex[r[11]] + hex[r[12]] + hex[r[13]] + hex[r[14]] + hex[r[15]]
        );
    }

    function set_group_error(msg) {
        const el = document.getElementById("group-join-error");
        if (!el) return;

        if (!msg) {
            el.style.display = "none";
            el.innerText = "";
            return;
        }

        el.style.display = "block";
        el.innerText = msg;
    }

    function clear_group_error() {
        set_group_error("");
    }

    function set_instructions_error(msg) {
        const el = document.getElementById("instructions-error");
        if (!el) return;

        if (!msg) {
            el.style.display = "none";
            el.innerText = "";
            return;
        }

        el.style.display = "block";
        el.innerText = msg;
    }

    function toggle_group_ui(btn) {
        const panel = document.getElementById("group-ui");
        if (!panel || !btn) return;

        const isHidden = panel.style.display === "none" || panel.style.display === "";
        panel.style.display = isHidden ? "block" : "none";

        if (isHidden) {
            _setButtonText(btn, "Hide group options");
        } else {
            _setButtonText(btn, "Take the test as part of a group");
        }
    }

    function create_group() {
        clear_group_error();

        let gid = "";
        try {
            gid = (crypto && typeof crypto.randomUUID === "function") ? crypto.randomUUID() : _uuidFallback();
        } catch (e) {
            set_group_error("Failed to create a group. Refresh and try again.");
            return;
        }

        window.location = "/instructions?g=" + encodeURIComponent(gid);
    }

    function join_group() {
        clear_group_error();

        const el = document.getElementById("group-id-input");
        const gid = el ? (el.value || "").trim() : "";

        if (!gid) {
            set_group_error("Paste a Group ID first.");
            return;
        }

        if (!_isUUID(gid)) {
            set_group_error("Invalid Group ID format (must be a UUID).");
            return;
        }

        window.location = "/instructions?g=" + encodeURIComponent(gid);
    }

    async function copy_group_link(tar, btn_text = "Copy Group Link") {
        const gid = _getGroupId();
        if (!gid || !tar) return;

        disable_button(tar, "Copied");

        const link = window.location.origin + "/data?g=" + encodeURIComponent(gid);

        try {
            await navigator.clipboard.writeText(link);
        } catch (e) {
            // fallback
            const tmp = document.createElement("textarea");
            tmp.value = link;
            document.body.appendChild(tmp);
            tmp.select();
            document.execCommand("copy");
            document.body.removeChild(tmp);
        }

        setTimeout(function () {
            enable_button(tar, btn_text);
        }, 2500);
    }

    function leave_group() {
        window.location = "/instructions?g=clear";
    }

    function render_group_state() {
        const gid = _getGroupId();

        const groupUI = document.getElementById("group-ui");
        const setup = document.getElementById("group-setup");
        const active = document.getElementById("group-active");
        const label = document.getElementById("group-id-label");
        const toggleBtn = document.getElementById("toggle-group-ui");

        const inGroup = (gid && _isUUID(gid));

        if (label) label.innerText = inGroup ? gid : "";

        if (setup) setup.style.display = inGroup ? "none" : "block";
        if (active) active.style.display = inGroup ? "block" : "none";

        // Auto-open panel if already in a group
        if (groupUI) groupUI.style.display = inGroup ? "block" : "none";

        if (toggleBtn) {
            _setButtonText(toggleBtn, inGroup ? "Hide group options" : "Take the test as part of a group");
        }
    }

    render_group_state();

    // Takes user to /test
    function start_test() {
        set_instructions_error("");

        $.ajax({
            type: "POST",
            url: "/api/to_test",
            contentType: "application/json",
            data: JSON.stringify({ "action": "to_test" }),
            success: function () {
                window.location = "/test";
            },
            error: function (xhr) {
                const msg =
                    (xhr.responseJSON && xhr.responseJSON.status) ||
                    ("Request failed (" + xhr.status + "). Please refresh and try again.");

                set_instructions_error(msg);
            }
        });
    }
</script>
{% endblock %}
