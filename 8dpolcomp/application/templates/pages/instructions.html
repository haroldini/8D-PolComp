
{% extends "layouts/base.html" %}

{% block TITLE %} â€¢ Test{% endblock %}

{% block CONTENT %}

<meta id="group-data" data-group="{{ group_id or '' }}">

<div class="component-border">
    <p class="text text-subtitle">Instructions</p>

    <div class="components-50-50">
        <div class="component-border">
            <p class="text">
                You will be shown a series of political statements, and your responses to them will be recorded.
                At the end of the test, your responses will be used to determine your position across eight ideological axes.
            </p>
        </div>
    </div>

    <div class="components-50-50">
        <div class="component-border">
            <p class="text text-subtitle fade-border header-underline">Group Test (optional)</p>
            <p class="text">
                Create a group and share the link. Anyone using the link will be added to the same group so you can compare results later.
            </p>

            <div class="components-50-50">
                <div class="component-border">
                    <button class="button grey-button center-content flex" onclick="create_group()">
                        <i class="fa-solid fa-people-group"></i>Create Group
                    </button>
                </div>

                <div class="component-border">
                    <input
                        id="group-id-input"
                        class="button grey-button"
                        style="width:100%; text-align:center;"
                        type="text"
                        placeholder="Paste Group ID (UUID)"
                    >
                    <button class="button grey-button center-content flex" style="margin-top:8px;" onclick="join_group()">
                        <i class="fa-solid fa-right-to-bracket"></i>Join Group
                    </button>
                </div>
            </div>

            <div id="group-active" class="component-border component" style="display:none; margin-top: 12px;">
                <p class="text green" style="margin-bottom:6px;">
                    <b>Current group:</b> <span id="group-id-label"></span>
                </p>
                <div class="wrapper">
                    <div class="wrapped">
                        <button class="button blue-button center-content flex" onclick="copy_group_link()">
                            <i class="fa-solid fa-clipboard"></i>Copy Group Link
                        </button>
                    </div>
                    <div class="wrapped">
                        <button class="button grey-button center-content flex" onclick="leave_group()">
                            <i class="fa-solid fa-xmark"></i>Leave Group
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="components-50-50">
        <div class="component-border">
            <button class="button blue-button" onclick="start_test()">
                <i class="fa-solid fa-right-long"></i>Continue
            </button>
        </div>
    </div>

</div>

{% endblock %}

{% block SCRIPTS %}
<script>
    function _isUUID(s) {
        const v = String(s || "").trim();
        return /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/.test(v);
    }

    function _getGroupId() {
        const meta = document.getElementById("group-data");
        const gid = meta ? (meta.getAttribute("data-group") || "").trim() : "";
        return gid || "";
    }

    function _uuidFallback() {
        const hex = [...Array(256).keys()].map(i => (i).toString(16).padStart(2, "0"));
        const r = crypto.getRandomValues(new Uint8Array(16));
        r[6] = (r[6] & 0x0f) | 0x40;
        r[8] = (r[8] & 0x3f) | 0x80;
        return (
            hex[r[0]] + hex[r[1]] + hex[r[2]] + hex[r[3]] + "-" +
            hex[r[4]] + hex[r[5]] + "-" +
            hex[r[6]] + hex[r[7]] + "-" +
            hex[r[8]] + hex[r[9]] + "-" +
            hex[r[10]] + hex[r[11]] + hex[r[12]] + hex[r[13]] + hex[r[14]] + hex[r[15]]
        );
    }

    function create_group() {
        let gid = "";
        try {
            gid = (crypto && typeof crypto.randomUUID === "function") ? crypto.randomUUID() : _uuidFallback();
        } catch (e) {
            alert("Failed to create group. Refresh and try again.");
            return;
        }
        window.location = "/instructions?g=" + encodeURIComponent(gid);
    }

    function join_group() {
        const el = document.getElementById("group-id-input");
        const gid = el ? (el.value || "").trim() : "";
        if (!gid) {
            alert("Paste a Group ID first.");
            return;
        }
        if (!_isUUID(gid)) {
            alert("Invalid Group ID format (must be a UUID).");
            return;
        }
        window.location = "/instructions?g=" + encodeURIComponent(gid);
    }

    async function copy_group_link() {
        const gid = _getGroupId();
        if (!gid) return;

        const link = window.location.origin + "/data?g=" + encodeURIComponent(gid);

        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(link);
                alert("Group link copied.");
                return;
            }
        } catch (e) {
            // ignore fallback below
        }

        window.prompt("Copy group link:", link);
    }

    function leave_group() {
        window.location = "/instructions?g=clear";
    }

    function render_group_state() {
        const gid = _getGroupId();
        const box = document.getElementById("group-active");
        const label = document.getElementById("group-id-label");
        if (!box || !label) return;

        if (gid && _isUUID(gid)) {
            label.innerText = gid;
            box.style.display = "block";
        } else {
            box.style.display = "none";
        }
    }

    render_group_state();

    // Takes user to /test
    function start_test() {
        $.ajax({
            type: "POST",
            url: "/api/to_test",
            contentType: "application/json",
            data: JSON.stringify({ "action": "to_test" }),
            success: function () {
                window.location = "/test";
            },
            error: function (xhr) {
                const msg =
                    (xhr.responseJSON && xhr.responseJSON.status) ||
                    ("Request failed (" + xhr.status + "). Please refresh and try again.");
                alert(msg);
            }
        });
    }
</script>
{% endblock %}
